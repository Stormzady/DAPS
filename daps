#!/usr/bin/python3
import os
import sys
import shutil
import readline
import subprocess
import signal
import json
import importlib.util

# DO NOT MODIFY ANYTHING BELOW THIS LINE UNLESS YOU KNOW WHAT YOU ARE DOING!
devmode = False
COLOR_RE = "\033[0m"
COLOR_USER = "\033[92m"
COLOR_HOST = "\033[94m"
COLOR_CWD = "\033[96m"
COLOR_ERR = "\033[91m"

plugins = {}

def loadconf():
        conf_dir = os.path.expanduser("~/.config/daps")
        whereis = os.path.join(conf_dir, "config.json")
        plugin_dir = os.path.join(conf_dir, "plugins")
        
        if not os.path.exists(plugin_dir):
                os.makedirs(plugin_dir)
        
        if not os.path.exists(whereis):
                with open(whereis, "w") as f:
                        f.write('{"aliases": {}, "cleargreet": "no"}')
        
        for filename in os.listdir(plugin_dir):
                if filename.endswith(".py"):
                        plugin_name = filename[:-3]
                        try:
                                spec = importlib.util.spec_from_file_location(plugin_name, os.path.join(plugin_dir, filename))
                                module = importlib.util.module_from_spec(spec)
                                spec.loader.exec_module(module)
                                plugins[plugin_name] = module
                        except Exception as e:
                                print(f"Failed to load plugin {plugin_name}: {e}")
        
        try:
                with open(whereis, "r") as f:
                        return json.load(f)
        except json.JSONDecodeError:
                print("Invalid JSON in the config file.")
                sys.exit(255)

config = loadconf()
alias = config.get("aliases", {})
cleargreet = config.get("cleargreet", "no") == "yes"

# --- AUTO-SUGGESTION LOGIC ---
def completer(text, state):
        # Combine aliases, plugins, and built-ins for suggestions
        options = [c for c in list(alias.keys()) + list(plugins.keys()) + ["cd", "exit", "clear", "update"] if c.startswith(text)]
        if state < len(options):
                return options[state]
        else:
                return None

readline.set_completer(completer)
readline.parse_and_bind("tab: complete")
# -----------------------------

signal.signal(signal.SIGINT, lambda sig, frame: sys.exit(255))

historyfile = os.path.expanduser("~/.daps.history")
if os.path.exists(historyfile):
        try: readline.read_history_file(historyfile)
        except: pass

user = subprocess.run(["whoami"], capture_output=True, text=True).stdout.strip()
try:
        with open("/etc/hostname", "r") as hf: hostn = hf.read().strip()
except:
        hostn = "daps-station"

def clear(): os.system("clear")
def runfc(confsec):
        torun = config.get(confsec)
        if torun: os.system(torun)

clear()
runfc("greeter")

errcode = None
while True:
        try:
                cwd = os.getcwd()
                home = os.path.expanduser("~")
                display_cwd = cwd.replace(home, "~", 1) if cwd.startswith(home) else cwd
                iden = "#" if user == "root" else "$"
                
                prompt_prefix = f"{COLOR_ERR}[{errcode}]{COLOR_RE} - " if errcode and errcode != "0" else ""
                print(f"{prompt_prefix}{COLOR_USER}{user}{COLOR_RE}@{COLOR_HOST}{hostn}{COLOR_RE} {COLOR_USER}({iden}){COLOR_RE} - {COLOR_CWD}{display_cwd}{COLOR_RE}")
                
                try:
                        raw_input = input(f"{COLOR_USER}>{COLOR_HOST} ").strip()
                except EOFError: sys.exit(0)
                except KeyboardInterrupt: 
                        print("")
                        continue

                if not raw_input: continue
                
                parts = raw_input.split()
                cmd_base = parts[0]
                args = parts[1:]

                if cmd_base in alias:
                        translated = alias[cmd_base]
                        for i, arg in enumerate(args):
                                translated = translated.replace(f"${i+1}", arg)
                        translated = translated.replace("$*", " ".join(args))
                        cmd_parts = translated.split()
                else:
                        cmd_parts = parts

                ccmd = cmd_parts[0]
                ccmar = cmd_parts[1:]

                if ccmd == "cd":
                        try:
                                os.chdir(os.path.expanduser(ccmar[0] if ccmar else home))
                                errcode = "0"
                        except Exception as e: print(e); errcode = "1"
                elif ccmd == "exit":
                        sys.exit(0)
                elif ccmd == "clear":
                        clear()
                        if cleargreet: runfc("greeter")
                        errcode = "0"
                elif ccmd in plugins:
                        try:
                                errcode = str(plugins[ccmd].run(ccmar))
                        except Exception as e:
                                print(f"Plugin Error: {e}")
                                errcode = "1"
                else:
                        result = subprocess.run(" ".join(cmd_parts), shell=True)
                        errcode = str(result.returncode)

        except Exception as e: print(f"Shell Error: {e}")
        finally:
                try: readline.write_history_file(historyfile)
                except: pass